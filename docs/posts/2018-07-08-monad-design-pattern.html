<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codata of Consciousness - 2018-07-08-monad-design-pattern</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Josefin+Sans:400,400i,700,700i|Josefin+Slab:400,400i,700,700i" />
    <link rel="stylesheet" type="text/css" href="../css/pure-min.css" />
    <link rel="stylesheet" type="text/css" href="../css/grids-responsive-min.css" />
    <link rel="stylesheet" type="text/css" href="../css/default.css" />
    <link rel="stylesheet" type="text/css" href="../css/tao-yin.css" />
    <script src="../js/highlight.pack.js"></script>
  </head>
  <body>
    <div class="pure-g" id="full-page">
      <div id="header" class="pure-u-1 pure-u-xl-1-6 pure-u-lg-1-5 pure-u-md-1-4 column">
        <div id="logo">
          <a href="../">Codata of<br />Consciousness</a>
          <img src="../images/spacer.png" class="spacer" />
        </div>
        <nav id="navigation">
          <ul>
            <li><a href="../">Home</a></li>
            <li><a href="../about.html">About</a></li>
            <li><a href="../projects.html">Workbench</a></li>
            <li><a href="../contact.html">Contact</a></li>
            <li><a href="../archive.html">Blog Posts</a></li>
          </ul>
        </nav>
      </div>

      <div class="pure-u-1 pure-u-xl-5-6 pure-u-lg-4-5 pure-u-md-3-4 column" id="main">
        <a name="top"></a>
        <div id="title">
          <h1>2018-07-08-monad-design-pattern</h1>
        </div>
        <div id="content">
          <div class="info">
    Posted on July  8, 2018
    
    <br />
    Go to <a href="#comments">comments</a>.
</div>

<div id="full-page" class="pure-g">
<div id="header" class="pure-u-1 pure-u-xl-1-6 pure-u-lg-1-5 pure-u-md-1-4 column">
<div id="logo">
<a href="../">Codata of<br />
Consciousness</a>
<img src="../images/spacer.png" class="spacer" />
</div>
<nav id="navigation">
<ul>
<li><a href="../">Home</a></li>
<li><a href="../about.html">About</a></li>
<li><a href="../projects.html">Workbench</a></li>
<li><a href="../contact.html">Contact</a></li>
<li><a href="../archive.html">Blog Posts</a></li>
</ul>
</nav>
</div>
<div id="main" class="pure-u-1 pure-u-xl-5-6 pure-u-lg-4-5 pure-u-md-3-4 column">
<span id="top"></span>
<div id="title">
<h1 id="monads-as-design-patterns">Monads as Design Patterns</h1>
</div>
<div id="content">
<div class="info">
Posted on July 8, 2018<br />
Go to <a href="#comments">comments</a>.
</div>
<p>Functional abstractions like <code>Monad</code>s are often presented in the contexts of typeclasses, with attendent libraries and syntax to learn.</p>
<p>I think typeclasses are fantastic. But I also think that this creates an additional hurdle. So I’d like to focus on abstractions as design patterns. We want to solve an issue; we have some goal in mind which we don’t know how to reach yet, but the pattern gives us some relatively easy-to-assemble but not immediately straightforward methods to reach that goal.</p>
<p>With that in mind, today I’d like to cover <code>Monad</code>s, with a glance at <code>Applicative</code>s as well (later, I’ll cover the similarities and differences between them). In the next post, I’ll present <code>Comonad</code>s as a similar design pattern.</p>
<p>So to be clear:</p>
<p><strong>Goal</strong>: To be able to compose multiple items with the same added functionality <strong>Pattern</strong>: Implement <code>flatMap</code>, <code>map</code>, and <code>unit</code> methods.</p>
<p>(You may notice that I’m taking a Scala approach here instead of the previous Haskell-based posts. First, if you’re learning Haskell, you have probably already been convinced of the use of abstractions such as <code>Monad</code>s. Second, I’m working as a Scala dev now, so this is my life at the moment, for good or for ill.)</p>
<h2 id="the-reader-monad">The Reader Monad</h2>
<p>To start, let’s take the <code>Reader</code> monad. <code>Reader[R,A]</code> is dependency injection - give a value of type <code>R</code>, and use it to calculate some <code>A</code>. The following example doesn’t use any typeclass magic or anything, or actually any libraries at all; just the basic few functions required by a <code>Monad</code> so that we can compose steps.</p>
<div id="cb1" class="sourceCode">
<div class="sourceCode" id="cb1"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">](</span>runReader<span class="op">:</span> R <span class="op">=&gt;</span> A<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="co">// To create some syntactic sugar for using Reader instances &amp;&amp; properly encapsulate</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// `runReader` above</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>r<span class="op">:</span> R<span class="op">):</span> A <span class="op">=</span> <span class="fu">runReader</span><span class="op">(</span>r<span class="op">)</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">// To change the value of a Reader without changing how it uses its dependency R</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>B<span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">((</span>r<span class="op">:</span> R<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span><span class="fu">runReader</span><span class="op">(</span>r<span class="op">)))</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// To change the value of a Reader in a way that uses its dependency R</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>B<span class="op">]):</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>B<span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">((</span>r<span class="op">:</span> R<span class="op">)</span> <span class="op">=&gt;</span> <span class="fu">f</span><span class="op">(</span><span class="fu">runReader</span><span class="op">(</span>r<span class="op">))(</span>r<span class="op">))</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">Reader</span> <span class="op">{</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// More syntactic sugar to not have to type `new` all the time</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>R<span class="op">,</span>A<span class="op">](</span>f<span class="op">:</span> R <span class="op">=&gt;</span> A<span class="op">):</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> <span class="ex">Reader</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Take a value which doesn't use a dependency R and let it be treated as a Reader</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// which ignores the input</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="dt">unit</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">((</span>_r<span class="op">:</span> R<span class="op">)</span> <span class="op">=&gt;</span> a<span class="op">)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Technically part of a `Traversable` pattern, but I leave it here to illustrate</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="co">// something `Monad`s can do that `Applicative`s could not</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sequence<span class="op">[</span>R<span class="op">,</span>A<span class="op">](</span>values<span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span><span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">]]):</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span> <span class="bu">Seq</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    values<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">Reader</span><span class="op">.</span><span class="dt">unit</span><span class="op">[</span>R<span class="op">,</span> <span class="bu">Seq</span><span class="op">[</span>A<span class="op">]](</span><span class="bu">Seq</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">]))</span> <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>acc<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      acc<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span> currentList <span class="op">=&gt;</span> next<span class="op">.</span><span class="fu">map</span><span class="op">(</span>currentList <span class="op">:+</span> _<span class="op">))</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<p>And with that, let’s create some sort of config which can be passed in as a dependency:</p>
<div id="cb2" class="sourceCode">
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="kw">class</span> <span class="fu">Config</span><span class="op">(</span>name<span class="op">:</span> <span class="ex">Option</span><span class="op">[</span><span class="ex">String</span><span class="op">],</span> exclamations<span class="op">:</span> <span class="bu">Int</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Now that we have the setup, let’s create some config-dependent values:</p>
<div id="cb3" class="sourceCode">
<div class="sourceCode" id="cb3"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> greet<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Config<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">(</span>cfg <span class="op">=&gt;</span> <span class="st">&quot;hello &quot;</span> <span class="op">+</span> cfg<span class="op">.</span>name<span class="op">.</span><span class="fu">getOrElse</span><span class="op">(</span><span class="st">&quot;world&quot;</span><span class="op">))</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> exclaim<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Config<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="ex">Reader</span><span class="op">(</span>cfg <span class="op">=&gt;</span> <span class="st">&quot;!&quot;</span> <span class="op">*</span> cfg<span class="op">.</span>exclamations<span class="op">)</span></span></code></pre></div>
</div>
<p>We have two different ways to combine these before having to pass in any configuration - we can stack our <code>Reader</code> legos together to get more <code>Reader</code>s. The first way uses the fact that we implemented <code>flatMap</code> and <code>map</code> to use Scala’s <code>for</code> syntax:</p>
<div id="cb4" class="sourceCode">
<div class="sourceCode" id="cb4"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> fored<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Config<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    greeting <span class="op">&lt;-</span> greet</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    exclamation <span class="op">&lt;-</span> exclaim</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>greeting <span class="op">+</span> exclamation<span class="op">)</span></span></code></pre></div>
</div>
<p>And the second way uses the <code>sequence</code> function we implemented to be able to take an entire sequence of config-dependent values (perhaps determined dynamically at runtime) and wrap them into a single config-dependent value:</p>
<div id="cb5" class="sourceCode">
<div class="sourceCode" id="cb5"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sequenced<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>Config<span class="op">,</span> <span class="ex">String</span><span class="op">]</span> <span class="op">=</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Reader</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span>greet<span class="op">,</span> exclaim<span class="op">)).</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>mkString<span class="op">)</span></span></code></pre></div>
</div>
<p>Now let’s run all three versions with configuration added:</p>
<div id="cb6" class="sourceCode">
<div class="sourceCode" id="cb6"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>@ <span class="fu">sequenced</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">),</span> <span class="dv">3</span><span class="op">))</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>res36<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;hello Scala!!!&quot;</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>@ <span class="fu">fored</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="st">&quot;FP&quot;</span><span class="op">),</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>res37<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;hello FP!!!!!&quot;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>@ <span class="fu">lifted</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> <span class="dv">10</span><span class="op">))</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>res47<span class="op">:</span> <span class="ex">String</span> <span class="op">=</span> <span class="st">&quot;hello world!!!!!!!!!!&quot;</span></span></code></pre></div>
</div>
<h2 id="the-state-monad">The State Monad</h2>
<p>The <code>Reader</code> monad allows us to read in dependencies, but not to alter them. It is essentially a wrapper around a function <code>R =&gt; A</code>. If we want to update the value passed in, we’ll have to make sure that we output the updated version. This would give us a function such as: <code>S =&gt; (A, S)</code>. We can reuse most of the above code:</p>
<div id="cb7" class="sourceCode">
<div class="sourceCode" id="cb7"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>A<span class="op">](</span>runState<span class="op">:</span> S <span class="op">=&gt;</span> <span class="op">(</span>A<span class="op">,</span> S<span class="op">))</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">apply</span><span class="op">(</span>s<span class="op">:</span> S<span class="op">):</span> <span class="op">(</span>A<span class="op">,</span> S<span class="op">)</span> <span class="op">=</span> <span class="fu">runState</span><span class="op">(</span>s<span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> map<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> B<span class="op">):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">State</span><span class="op">((</span>s1<span class="op">:</span> S<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">runState</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span><span class="fu">f</span><span class="op">(</span>a<span class="op">),</span> s2<span class="op">)</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> flatMap<span class="op">[</span>B<span class="op">](</span>f<span class="op">:</span> A <span class="op">=&gt;</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>B<span class="op">]):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>B<span class="op">]</span> <span class="op">=</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">State</span><span class="op">((</span>s1<span class="op">:</span> S<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">runState</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">f</span><span class="op">(</span>a<span class="op">)(</span>s2<span class="op">)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper function for dealing with States</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">modify</span><span class="op">(</span>f<span class="op">:</span> S <span class="op">=&gt;</span> S<span class="op">):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">State</span><span class="op">(</span> s1 <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">val</span> <span class="op">(</span>a<span class="op">,</span> s2<span class="op">)</span> <span class="op">=</span> <span class="fu">runState</span><span class="op">(</span>s1<span class="op">)</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="op">(</span>a<span class="op">,</span> <span class="fu">f</span><span class="op">(</span>s2<span class="op">))</span></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">})</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="kw">object</span> <span class="ex">State</span> <span class="op">{</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> apply<span class="op">[</span>S<span class="op">,</span>A<span class="op">](</span>f<span class="op">:</span> S <span class="op">=&gt;</span> <span class="op">(</span>A<span class="op">,</span> S<span class="op">)):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>A<span class="op">]</span> <span class="op">=</span> <span class="kw">new</span> <span class="ex">State</span><span class="op">(</span>f<span class="op">)</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="dt">unit</span><span class="op">[</span>S<span class="op">,</span>A<span class="op">](</span>a<span class="op">:</span> A<span class="op">):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>A<span class="op">]</span> <span class="op">=</span> <span class="ex">State</span><span class="op">((</span>s<span class="op">:</span> S<span class="op">)</span> <span class="op">=&gt;</span> <span class="op">(</span>a<span class="op">,</span> s<span class="op">))</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> sequence<span class="op">[</span>S<span class="op">,</span>A<span class="op">](</span>values<span class="op">:</span> <span class="bu">Seq</span><span class="op">[</span><span class="ex">State</span><span class="op">[</span>S<span class="op">,</span>A<span class="op">]]):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span> <span class="bu">Seq</span><span class="op">[</span>A<span class="op">]]</span> <span class="op">=</span></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    values<span class="op">.</span><span class="fu">foldLeft</span><span class="op">(</span><span class="ex">State</span><span class="op">.</span><span class="dt">unit</span><span class="op">[</span>S<span class="op">,</span> <span class="bu">Seq</span><span class="op">[</span>A<span class="op">]](</span><span class="bu">Seq</span><span class="op">.</span>empty<span class="op">[</span>A<span class="op">]))</span> <span class="op">{</span> <span class="cf">case</span> <span class="op">(</span>acc<span class="op">,</span> next<span class="op">)</span> <span class="op">=&gt;</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>      acc<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span> currentList <span class="op">=&gt;</span> next<span class="op">.</span><span class="fu">map</span><span class="op">(</span>currentList <span class="op">:+</span> _<span class="op">))</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Readers are just States which pass their arguments through unchanged</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> fromReader<span class="op">[</span>R<span class="op">,</span>A<span class="op">](</span>reader<span class="op">:</span> <span class="ex">Reader</span><span class="op">[</span>R<span class="op">,</span>A<span class="op">]):</span> <span class="ex">State</span><span class="op">[</span>R<span class="op">,</span> A<span class="op">]</span> <span class="op">=</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="ex">State</span><span class="op">(</span>r <span class="op">=&gt;</span> <span class="op">(</span><span class="fu">reader</span><span class="op">(</span>r<span class="op">),</span> r<span class="op">))</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Helper functions for dealing with States</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get<span class="op">[</span>S<span class="op">]:</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span> S<span class="op">]</span> <span class="op">=</span> <span class="ex">State</span><span class="op">(</span> s <span class="op">=&gt;</span> <span class="op">(</span>s<span class="op">,</span> s<span class="op">))</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> put<span class="op">[</span>S<span class="op">](</span>newS<span class="op">:</span> S<span class="op">):</span> <span class="ex">State</span><span class="op">[</span>S<span class="op">,</span> <span class="bu">Unit</span><span class="op">]</span> <span class="op">=</span> <span class="ex">State</span><span class="op">(</span> _s <span class="op">=&gt;</span> <span class="op">((),</span> newS<span class="op">))</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
</div>
<p>It’s no fun having State to modify if we don’t modify it, so let’s add some functions to do so:</p>
<div id="cb8" class="sourceCode">
<div class="sourceCode" id="cb8"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> langs<span class="op">:</span> <span class="ex">List</span><span class="op">[</span><span class="ex">String</span><span class="op">]</span> <span class="op">=</span> <span class="ex">List</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">,</span> <span class="st">&quot;Haskell&quot;</span><span class="op">,</span> <span class="st">&quot;Purescript&quot;</span><span class="op">)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">rotateLangs</span><span class="op">(</span>cfg<span class="op">:</span> Config<span class="op">):</span> Config <span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  cfg<span class="op">.</span><span class="fu">copy</span><span class="op">(</span>name <span class="op">=</span> cfg<span class="op">.</span>name<span class="op">.</span><span class="fu">flatMap</span><span class="op">(</span>currLang <span class="op">=&gt;</span> langs <span class="fu">lift</span> <span class="op">(</span>langs<span class="op">.</span><span class="fu">indexOf</span><span class="op">(</span>currLang<span class="op">)</span> <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">%</span> langs<span class="op">.</span>length<span class="op">))</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">toneItUp</span><span class="op">(</span>cfg<span class="op">:</span> Config<span class="op">):</span> Config <span class="op">=</span> cfg<span class="op">.</span><span class="fu">copy</span><span class="op">(</span>exclamations <span class="op">=</span> cfg<span class="op">.</span>exclamations <span class="op">+</span> <span class="dv">1</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We’ll reuse our <code>Reader</code>s and have them modify the state while they read it:</p>
<div id="cb9" class="sourceCode">
<div class="sourceCode" id="cb9"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sGreet <span class="op">=</span> <span class="ex">State</span><span class="op">.</span><span class="fu">fromReader</span><span class="op">(</span>greet<span class="op">).</span><span class="fu">modify</span><span class="op">(</span>rotateLangs<span class="op">)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> sExclaim <span class="op">=</span> <span class="ex">State</span><span class="op">.</span><span class="fu">fromReader</span><span class="op">(</span>exclaim<span class="op">).</span><span class="fu">modify</span><span class="op">(</span>toneItUp<span class="op">)</span></span></code></pre></div>
</div>
<p>Running it once gives us the same results as before, except it also returns an updated version of our <code>Config</code>:</p>
<div id="cb10" class="sourceCode">
<div class="sourceCode" id="cb10"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> once <span class="op">=</span> <span class="cf">for</span> <span class="op">{</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   greeting <span class="op">&lt;-</span> sGreet</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>   exclamation <span class="op">&lt;-</span> sExclaim</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="cf">yield</span> <span class="op">(</span>greeting <span class="op">+</span> exclamation<span class="op">)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>@ <span class="fu">once</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> <span class="dv">5</span><span class="op">))</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>res33<span class="op">:</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> Config<span class="op">)</span> <span class="op">=</span> <span class="op">(</span><span class="st">&quot;hello world!!!!!&quot;</span><span class="op">,</span> <span class="fu">Config</span><span class="op">(</span><span class="bu">None</span><span class="op">,</span> <span class="dv">6</span><span class="op">))</span></span></code></pre></div>
</div>
<p>But we can also try running it multiple times in succession:</p>
<div id="cb11" class="sourceCode">
<div class="sourceCode" id="cb11"><pre class="sourceCode scala"><code class="sourceCode scala"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">val</span> thrice <span class="op">=</span> <span class="ex">State</span><span class="op">.</span><span class="fu">sequence</span><span class="op">(</span><span class="ex">List</span><span class="op">(</span>sGreet<span class="op">,</span> sExclaim<span class="op">,</span> sGreet<span class="op">,</span> sExclaim<span class="op">,</span> sGreet<span class="op">,</span> sExclaim<span class="op">))</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">map</span><span class="op">(</span>_<span class="op">.</span>mkString<span class="op">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>@ <span class="fu">thrice</span><span class="op">(</span><span class="fu">Config</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">),</span> <span class="dv">1</span><span class="op">))</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>res47<span class="op">:</span> <span class="op">(</span><span class="ex">String</span><span class="op">,</span> Config<span class="op">)</span> <span class="op">=</span> <span class="op">(</span><span class="st">&quot;hello Scala!hello Haskell!!hello Purescript!!!&quot;</span><span class="op">,</span> <span class="fu">Config</span><span class="op">(</span><span class="bu">Some</span><span class="op">(</span><span class="st">&quot;Scala&quot;</span><span class="op">),</span> <span class="dv">4</span><span class="op">))</span></span></code></pre></div>
</div>
<hr />
<span id="comments"></span>
<div id="disqus_thread">

</div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
var full_url = "https://nomicflux.github.io" + "/posts/2018-07-08-monad-design-pattern.html";
var identifier = "/posts/2018-07-08-monad-design-pattern.html".split("/")[2].split(".")[0];
var disqus_config = function () {
    this.page.url = full_url;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//http-nomicflux-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>
Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
</noscript>
<script id="dsq-count-scr" src="//http-nomicflux-github-io.disqus.com/count.js" async></script>
Return to <a href="#top">post</a>.
</div>
<div id="footer">
<div class="left">
© 2016 Michael Anderson
</div>
<div class="right">
Site generated by
<a href="http://jaspervdj.be/hakyll">Hakyll</a> <img src="../images/haskell-logo.png" />
</div>
</div>
</div>
</div>
<script>hljs.initHighlightingOnLoad();</script>

<hr />
<a name="comments"></a>
<div id="disqus_thread"></div>
<script>

/**
 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */
var full_url = "https://nomicflux.github.io" + "/posts/2018-07-08-monad-design-pattern.html";
var identifier = "/posts/2018-07-08-monad-design-pattern.html".split("/")[2].split(".")[0];
var disqus_config = function () {
    this.page.url = full_url;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
(function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = '//http-nomicflux-github-io.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//http-nomicflux-github-io.disqus.com/count.js" async></script>
Return to <a href="#top">post</a>.

        </div>
        <div id="footer">
          <div class="left">&copy; 2016-2025 Michael Anderson</div>
          <div class="right">
            Site generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a> <img src="../images/haskell-logo.png" />
          </div>
        </div>
      </div>
    </div>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
